name = "agent-ops"
main = "src/index.ts"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]
previews_enabled = false

# Environment variables (set via wrangler secret)
# ENCRYPTION_KEY - for encrypting stored credentials
# GITHUB_CLIENT_ID - GitHub OAuth app client ID
# GITHUB_CLIENT_SECRET - GitHub OAuth app client secret

[vars]
# ALLOWED_EMAILS - comma-separated email allowlist. Override via .dev.vars (local) or `wrangler secret put` (production)
ALLOWED_EMAILS = "${ALLOWED_EMAILS}"
# MODAL_BACKEND_URL - your Modal workspace URL template. Override via .dev.vars (local) or `wrangler secret put` (production)
MODAL_BACKEND_URL = "${MODAL_BACKEND_URL}"
# FRONTEND_URL - set via .dev.vars (local) or `wrangler secret put` (production)

# Define replacements for libraries that reference Node globals
[define]
"process.env.NODE_ENV" = "\"production\""

# Durable Objects
[[durable_objects.bindings]]
name = "API_KEYS"
class_name = "APIKeysDurableObject"

[[durable_objects.bindings]]
name = "SESSIONS"
class_name = "SessionAgentDO"

[[durable_objects.bindings]]
name = "EVENT_BUS"
class_name = "EventBusDO"

[[durable_objects.bindings]]
name = "WORKFLOW_EXECUTOR"
class_name = "WorkflowExecutorDO"

[[migrations]]
tag = "v1"
new_classes = ["APIKeysDurableObject", "EventBusDO"]
new_sqlite_classes = ["SessionAgentDO"]

[[migrations]]
tag = "v2"
new_classes = ["WorkflowExecutorDO"]

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "agent-ops-db"
# database_id - get this from `wrangler d1 create <name>`, set D1_DATABASE_ID in .env.deploy
database_id = "${D1_DATABASE_ID}"

# R2 Bucket
[[r2_buckets]]
binding = "STORAGE"
# bucket_name - create with `wrangler r2 bucket create <name>`, set R2_BUCKET_NAME in .env.deploy
bucket_name = "${R2_BUCKET_NAME}"

# Cron Triggers for scheduled syncs
[triggers]
crons = ["* * * * *", "0 3 * * *"] # Minutely reconcile + schedule dispatch; nightly archive at 3am UTC

# Observability (enables Worker and Container logs)
[observability]
enabled = true

# Development settings
[dev]
port = 8787
local_protocol = "http"
